#!/bin/bash

set -eo pipefail

heading() {
  echo "----->" $@;
}

line() {
  echo "      " $@;
}

run_command_indented() {
  $@ 2>&1 | awk '{print "       " $0}'
}

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

EJSON_FAIL_EARLY=0

heading "Installing ejson"
run_command_indented bundle install --path "$CACHE_DIR"

heading "Loading keypair from environment variables"
if [ ! -f "$ENV_DIR/EJSON_PUBLIC_KEY" ]; then
    heading 'EJSON_PUBLIC_KEY is undefined; make sure EJSON_PUBLIC_KEY and EJSON_PRIVATE_KEY are set (try `ejson keygen`)'
    heading 'Not decrypting anything'
    exit $EJSON_FAIL_EARLY
fi

if [ ! -f "$ENV_DIR/EJSON_PRIVATE_KEY" ]; then
    heading 'EJSON_PRIVATE_KEY is undefined; make sure EJSON_PUBLIC_KEY and EJSON_PRIVATE_KEY are set (try `ejson keygen`)'
    heading 'Not decrypting anything'
    exit $EJSON_FAIL_EARLY
fi
export EJSON_KEYDIR=$(mktemp -d)
trap 'rm -rf $EJSON_KEYDIR' EXIT
PUBLIC_KEY=$(cat "$ENV_DIR/EJSON_PUBLIC_KEY")
PRIVATE_KEY=$(cat "$ENV_DIR/EJSON_PRIVATE_KEY")
echo "$PRIVATE_KEY" > "$EJSON_KEYDIR/$PUBLIC_KEY"

heading "Enumerating and decrypting *.ejson files"
COUNTER=0
for FILE in $(find $BUILD_DIR -name '*.ejson'); do
  DECRYPTED_FILE=${FILE%.ejson}.json
  line "Decrypting ${FILE:${#BUILD_DIR}+1} --> ${DECRYPTED_FILE:${#BUILD_DIR}+1}"
  if bundle exec ejson decrypt "$FILE" > "$DECRYPTED_FILE" 2>&1; then
    let COUNTER+=1
  else
    line $(cat "$DECRYPTED_FILE") "[skipping and continuing]"
    rm "$DECRYPTED_FILE"
  fi
done
heading "Done. Decrypted $COUNTER different ejson file(s)"
